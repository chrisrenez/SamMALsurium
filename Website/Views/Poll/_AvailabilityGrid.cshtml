@model PollDetailsViewModel

@{
    var actionName = Model.HasUserVoted ? "ChangeVote" : "Vote";
    var buttonText = Model.HasUserVoted ? "Stimme aktualisieren" : "Abstimmen";
}

<form asp-action="@actionName" asp-route-id="@Model.Id" method="post" class="availability-grid-form" id="poll-form-@Model.Id">
    @Html.AntiForgeryToken()

    <div class="mb-3">
        <p class="text-muted small mb-3">
            <i class="bi bi-info-circle"></i> Markieren Sie Ihre Verfügbarkeit für jede Option.
        </p>

        <div class="table-responsive">
            <table class="table table-bordered availability-grid-table" role="grid" aria-label="Verfügbarkeitstabelle">
                <thead>
                    <tr role="row">
                        <th scope="col" style="width: 40%;">Option</th>
                        <th scope="col" class="text-center" style="width: 20%;">
                            <span class="badge bg-success">Ja</span>
                        </th>
                        <th scope="col" class="text-center" style="width: 20%;">
                            <span class="badge bg-warning text-dark">Vielleicht</span>
                        </th>
                        <th scope="col" class="text-center" style="width: 20%;">
                            <span class="badge bg-danger">Nein</span>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var option in Model.Options)
                    {
                        var currentAvailability = "No";
                        if (Model.UserVote != null && Model.UserVote is IDictionary<string, object> voteDict)
                        {
                            if (voteDict.ContainsKey("Availability"))
                            {
                                var availabilities = voteDict["Availability"] as IEnumerable<object>;
                                if (availabilities != null)
                                {
                                    foreach (var availObj in availabilities)
                                    {
                                        var availDict = availObj as IDictionary<string, object>;
                                        if (availDict != null && availDict.ContainsKey("OptionId") && availDict.ContainsKey("Availability"))
                                        {
                                            if (availDict["OptionId"].ToString() == option.Id.ToString())
                                            {
                                                currentAvailability = availDict["Availability"].ToString();
                                                break;
                                            }
                                        }
                                    }
                                }
                            }
                        }

                        <tr role="row">
                            <th scope="row">
                                <div class="fw-bold">@option.Label</div>
                                @if (!string.IsNullOrEmpty(option.AdditionalInfo))
                                {
                                    <div class="text-muted small">@option.AdditionalInfo</div>
                                }
                            </th>
                            <td class="text-center align-middle" role="gridcell">
                                @if (currentAvailability == "Yes")
                                {
                                    <input type="radio" id="availability-@option.Id-yes" name="availability_@option.Id" value="Yes" class="form-check-input" data-option-id="@option.Id" data-availability="yes" aria-label="Ja für @option.Label" checked>
                                }
                                else
                                {
                                    <input type="radio" id="availability-@option.Id-yes" name="availability_@option.Id" value="Yes" class="form-check-input" data-option-id="@option.Id" data-availability="yes" aria-label="Ja für @option.Label">
                                }
                            </td>
                            <td class="text-center align-middle" role="gridcell">
                                @if (currentAvailability == "Maybe")
                                {
                                    <input type="radio" id="availability-@option.Id-maybe" name="availability_@option.Id" value="Maybe" class="form-check-input" data-option-id="@option.Id" data-availability="maybe" aria-label="Vielleicht für @option.Label" checked>
                                }
                                else
                                {
                                    <input type="radio" id="availability-@option.Id-maybe" name="availability_@option.Id" value="Maybe" class="form-check-input" data-option-id="@option.Id" data-availability="maybe" aria-label="Vielleicht für @option.Label">
                                }
                            </td>
                            <td class="text-center align-middle" role="gridcell">
                                @if (currentAvailability == "No")
                                {
                                    <input type="radio" id="availability-@option.Id-no" name="availability_@option.Id" value="No" class="form-check-input" data-option-id="@option.Id" data-availability="no" aria-label="Nein für @option.Label" checked>
                                }
                                else
                                {
                                    <input type="radio" id="availability-@option.Id-no" name="availability_@option.Id" value="No" class="form-check-input" data-option-id="@option.Id" data-availability="no" aria-label="Nein für @option.Label">
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

    <div class="d-flex gap-2">
        <button type="submit" class="btn btn-primary">
            <i class="bi bi-check-circle"></i> @buttonText
        </button>
        @if (Model.EventId.HasValue)
        {
            <a href="@Url.Action("Details", "Event", new { id = Model.EventId })" class="btn btn-outline-secondary">
                Abbrechen
            </a>
        }
    </div>
</form>
