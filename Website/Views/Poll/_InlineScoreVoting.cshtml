@model PollDetailsViewModel

@{
    var actionName = Model.HasUserVoted ? "ChangeVote" : "Vote";
    var buttonText = Model.HasUserVoted ? "Stimme aktualisieren" : "Abstimmen";
    var scoreMin = Model.ScoreMin ?? 1;
    var scoreMax = Model.ScoreMax ?? 5;
}

<form asp-action="@actionName" asp-route-id="@Model.Id" method="post" class="score-voting-form" id="poll-form-@Model.Id">
    @Html.AntiForgeryToken()

    <div class="mb-3">
        <p class="text-muted small mb-3">
            <i class="bi bi-info-circle"></i> Bewerten Sie jede Option mit @scoreMin bis @scoreMax Punkten.
        </p>

        @foreach (var option in Model.Options)
        {
            var currentScore = scoreMin;
            if (Model.UserVote != null && Model.UserVote is IDictionary<string, object> voteDict)
            {
                if (voteDict.ContainsKey("Scores"))
                {
                    var scores = voteDict["Scores"] as IEnumerable<object>;
                    if (scores != null)
                    {
                        foreach (var scoreObj in scores)
                        {
                            var scoreDict = scoreObj as IDictionary<string, object>;
                            if (scoreDict != null && scoreDict.ContainsKey("OptionId") && scoreDict.ContainsKey("Score"))
                            {
                                if (scoreDict["OptionId"].ToString() == option.Id.ToString())
                                {
                                    currentScore = Convert.ToInt32(scoreDict["Score"]);
                                    break;
                                }
                            }
                        }
                    }
                }
            }

            <div class="card mb-3">
                <div class="card-body">
                    <div class="mb-2">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <div class="fw-bold">@option.Label</div>
                                @if (!string.IsNullOrEmpty(option.AdditionalInfo))
                                {
                                    <div class="text-muted small">@option.AdditionalInfo</div>
                                }
                            </div>
                            <span class="badge bg-primary score-display-@option.Id">@currentScore</span>
                        </div>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        <span class="small text-muted">@scoreMin</span>
                        <input type="range"
                               class="form-range flex-grow-1 score-slider"
                               name="score_@option.Id"
                               min="@scoreMin"
                               max="@scoreMax"
                               value="@currentScore"
                               data-option-id="@option.Id"
                               aria-label="Bewertung fÃ¼r @option.Label">
                        <span class="small text-muted">@scoreMax</span>
                    </div>
                </div>
            </div>
        }
    </div>

    <div class="d-flex gap-2">
        <button type="submit" class="btn btn-primary">
            <i class="bi bi-check-circle"></i> @buttonText
        </button>
        @if (Model.EventId.HasValue)
        {
            <a href="@Url.Action("Details", "Event", new { id = Model.EventId })" class="btn btn-outline-secondary">
                Abbrechen
            </a>
        }
    </div>
</form>
